$(function(){window.url=new URI("#"),window.binds={aPage:new Bind("a[data-page]","click"),aWindow:new Bind("a[data-window]","click"),hover:new Bind("header a","mousemove"),bodyScroll:new Bind(".page.general","scroll"),lazyLoad:new LazyLoad({}),titleHover:new hoverMenu(".ui-title",["\u041E\u0442\u043A\u0440\u044B\u0442\u044C","<span class=\"material-icons icon\">info</span>\u0418\u043D\u0444\u043E\u0440\u043C\u0430\u0446\u0438\u044F",{text:"<span class=\"material-icons icon\">favorite</span>\u041B\u044E\u0431\u0438\u043C\u043E\u0435",action:"stay",classes:["ui-disabled"]},{text:"<span class=\"material-icons icon\">gps_not_fixed</span>\u041E\u0442\u0441\u043B\u0435\u0436\u0438\u0432\u0430\u0442\u044C",action:"stay",classes:["ui-disabled"]},"<span class=\"material-icons icon\">content_copy</span>\u0421\u043A\u043E\u043F\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u0435",{text:"<span class=\"icon\" style=\"background-color:rgba(var(--colorFill),0.5)\"><img alt=\"sk\" src=\"https://shikimori.one/assets/layouts/l-top_menu-v2/glyph.svg\" height=\"24\"></span>\u041E\u0442\u043A\u0440\u044B\u0442\u044C \u0432 Shikimori",classes:["externalLink"]}],{classes:["icon-list","ui-hovermenu","ui-material-list"]}),config:new configCollector,anilibria:new Anilibria,kodik:new kodik(".page.player .player-kodik"),sHistory:new listStorage("sHistory"),sFavorite:new listStorage("sFavorite")},$(function(){binds.hover.bind(function(a){$(this).css({"--x":a.offsetX+"px","--y":a.offsetY+"px"})},"jq.custom"),c.init(),$("body").contextmenu(a=>{null===b.current?c.set("general"):b.close(),a.preventDefault()}),binds.aPage.bind(function(){c.set($(this).attr("data-page"))},"jq.custom")}),url.onRedirect(a=>{console.groupCollapsed("Redirected to #"+url.address),console.log(a),console.groupEnd(),c.processor()}),window.toRGB=function(a){let b=a.split(""),c=parseInt(b[1]+b[2],16),d=parseInt(b[3]+b[4],16),e=parseInt(b[5]+b[6],16);return[c,d,e]};let a={title(a,b,c,d,e){return`<a data-page="player" href="#player/shikimori/${a}" title="${d}"><div class="ui-title" data-add='${JSON.stringify(e)}'><img alt="${d}" class="lazy" src="${e.image.original===void 0?"":"//shikimori.one"+e.image.preview}" data-src="//shikimori.one${binds.config.config.highPreview?e.image.original||b:b}"><div></div></div></a>`},textTitle(a){return`<h2>${a}</h2>`},minTitle(a,b,c){return`<a data-window="search" data-add='{"text":"${a}"}'><div class="ui-min-title" style="--from:'${c}'" title="Время: ${b}"><h4>${a}</h4></div></a>`},titleEx(a,b,c,d,e){return`<a data-page="player" href="#player/shikimori/${a}" title="${d}"><div><div class="ui-title" data-add='${JSON.stringify(e)}'><img alt="${d}" class="lazy" src="//shikimori.one${e.image.preview}" data-src="//shikimori.one${binds.config.config.highPreview?e.image.original:b}"></div><span>${c||d}</span></div></a>`},titleInfo(b){return`<div class="ui-title inactive" data-add='${JSON.stringify(b)}' style="margin:auto"><img alt="${b.name}" src="//shikimori.one${b.image.original}"></div><h2 style="margin:auto" title="${b.name}">${b.russian||b.name} [${b.kind}]</h2><hr/><table class="ui-table-v"><tbody><tr><td>Статус</td><td>${b.status||"\u041D\u0435\u0438\u0437\u0432\u0435\u0441\u0442\u043D\u043E"}</td></tr><tr><td>Рейтинг</td><td>${b.score}</td></tr><tr><td>Анонсирован</td><td>${b.aired_on||"\u041D\u0435\u0438\u0437\u0432\u0435\u0441\u0442\u043D\u043E"}</td></tr><tr><td>Закончен</td><td>${b.released_on||"\u041D\u0435\u0438\u0437\u0432\u0435\u0441\u0442\u043D\u043E"}</td></tr><tr><td>Оригинал</td><td>${b.name}</td></tr><tr><td>Эпизоды</td><td>${b.episodes_aired}/${b.episodes}</td></tr></tbody></table><hr><ui class="icon-list ui-material-list"><li onclick="url.set('#player/shikimori/${b.id}',{})">Открыть</li><li class="ui-disabled"><span class="material-icons icon">favorite</span>Любимое</li><li class="ui-disabled"><span class="material-icons icon">gps_not_fixed</span>Отслеживать</li><li onclick="window.open('//shikimori.one${b.url}')"><span class="icon" style="background-color:rgba(var(--colorFill),0.5)"><img alt="sk" src="https://shikimori.one/assets/layouts/l-top_menu-v2/glyph.svg" height="24"></span>Открыть в Shikimori</li></ui><hr><h3>Хронология</h3><ui class="ui-material-list timeline">${a.loadingResults()}</ui><hr><h3>Ссылки</h3><ui class="ui-material-list icon-list links">${a.loadingResults()}</ui>`},loadingResults(){return"<div class=\"ui-load\"><span class=\"material-icons\">hourglass_empty</span></div>"},noResults(a="\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043D\u0438\u0447\u0435\u0433\u043E \u043D\u0430\u0439\u0442\u0438"){return"<div class=\"ui-error\"><div><span class=\"material-icons\">announcement</span><h5>"+a+"</h5></div></div>"},progress(a,b=2){let c=a[1],d=[],e=360/Object.keys(c).filter(a=>"0B"===c[a].size?null:a).length,f=[];return Object.keys(c).filter(a=>"0B"===c[a].size?null:a).forEach((a,g)=>{let h=Math.ceil(c[a].part*10**(b+2))/10**b;d.push(`<div title="${a} - ${h}%" style="--color:${c[a].color||e*g}deg;--part:${c[a].part}"></div>`),f.push(`<div style="--color:${c[a].color||e*g}deg" title="${h}%" class="ui-progress-part">${c[a].description||a} (${c[a].size})</div>`)}),`<span>Всего: ${a[0]}</span><div class="ui-progress">${d.join("")}</div>${f.join("")}`},playerBar(a){return`<a class="material-icons" data-window="title-info" data-add='${JSON.stringify(a)}' title="Информация">info</a><span>${a.russian||a.name}</span>`},materialItem(a,b){return`${b.window||b.page||b.href?`<a ${b.data||b.href?` href="${b.data||b.href}"`:""} ${b.href?"target=\"_blank\"":""} ${b.page?`data-page='${b.page}'`:""} ${b.window?`data-window='${b.window}'${b.data?` data-add="${b.data}"`:""}`:""}>`:""}<li ${b.active?"class=\"active\"":""}>${a}</li>${b.window||b.page||b.href?`</a>`:""}`}};binds.config.change((a,b)=>{let c=$("body");return"disableAnimations"===a?c.attr("disableAnimations",b.toString()):"showTime"===a?$(".ui-clock").attr("display",b.toString()):"showReleases"===a?$("header [data-window=releases]").attr("display",b.toString()):"showHistory"===a?$("header [data-window=history]").attr("display",b.toString()):"showFavorite"===a?$("header [data-window=favorite]").attr("display",b.toString()):"colorBG"===a?c.css("--colorBackground",toRGB(b).join(", ")):"colorText"===a?c.css("--colorText",toRGB(b).join(", ")):"colorFill"===a?c.css("--colorFill",toRGB(b).join(", ")):"colorHref"===a?c.css("--colorHref",toRGB(b).join(", ")):"highEffects"===a?c.attr("highEffects",b.toString()):"playerMode"===a?$("div.page.player, div.window.config div.player-preview").attr("playerMode",b):"showTracking"===a?$("header [data-window=tracking]").attr("display",b.toString()):void 0});let b={container:!1,current:null,bind(){binds.aWindow.bind(a=>{let b=JSON.parse(a.delegateTarget.dataset.add||"{}"),c=a.delegateTarget.dataset.window;return c===this.current&&this.container?this.close():this.open(c,b)},"windows.bind"),$(".windows").click(a=>{a.target.classList.contains("windows")&&this.close()})},open(a,b={}){null===this.current?!this.container&&$(".windows").addClass("use"):$(".window."+this.current).removeClass("active"),$(".window."+a).addClass("active"),this.current=a,this.container=!0,this.array[a]&&this.array[a](b)},close(){$(".window."+this.current).removeClass("active"),this.current=null,$(".windows").removeClass("use"),this.container=!1},array:{config:()=>{$(".window.config .storage").html(a.progress(d.storage._data()))},"title-info":b=>{$(".windows .window.title-info .ui-grid").html(a.titleInfo(b));let c=$(".window.title-info .ui-material-list.timeline"),e=$(".window.title-info .ui-material-list.links");shikimori.anime(b.id).franchise().then(d=>{c.html(""),d.nodes.forEach(d=>{c.append(a.materialItem(d.name,{page:"player",data:`#player/shikimori/${d.id}`,active:d.id===b.id}))}),binds.aPage.update()}),shikimori.anime(b.id).external_links().then(b=>{e.html(""),b.forEach(b=>{e.append(a.materialItem(`<span class="icon"><img src="https://shikimori.one/assets/blocks/b-external_links/${b.kind}.png" height="100%"></span>${d.shikimori.linkTitle(b.kind)||b.kind}`,{href:b.url}))})})},search:a=>{a.text&&($(".window.search input[type=text]").val(a.text),d.search.search(a.text)),$(".window.search .search-input>input[type=text]").focus().unbind("keypress").keypress(a=>{("Enter"===a.key||3<=$(".window.search input[type=text]").val().length&&binds.config.config.realtimeSearch)&&d.search.search($(".window.search input[type=text]").val())}),$(".window.search .search-input>button").unbind("click").click(()=>{d.search.search($(".window.search input[type=text]").val())})},releases:()=>{let b=$(".releases-filter"),c=$(".window.releases .results"),e=[[],[],[],[],[],[],[]],f=["\u041F\u043E\u043D\u0435\u0434\u0435\u043B\u044C\u043D\u0438\u043A","\u0412\u0442\u043E\u0440\u043D\u0438\u043A","\u0421\u0440\u0435\u0434\u0430","\u0427\u0435\u0442\u0432\u0435\u0440\u0433","\u041F\u044F\u0442\u043D\u0438\u0446\u0430","\u0421\u0443\u0431\u0431\u043E\u0442\u0430","\u0412\u043E\u0441\u043A\u0440\u0435\u0441\u0435\u043D\u044C\u0435"];b.unbind("change").change(()=>h(b.val()));let g=()=>{c.html(""),e.forEach((b,e)=>{c.append(a.textTitle(f[e])),b.forEach(b=>{c.append(a.minTitle(b.name,b.time,b.from))})}),binds.aWindow.update()},h=b=>{switch(c.html(a.loadingResults()),b){case"animevost":d.schedule.animevost().then(a=>{e=a,g()});break;case"anilibria":d.schedule.anilibria().then(a=>{e=a,g()});break;default:d.schedule.all().then(a=>{e=a,g()});}};h(b.val())},history(){let b=$(".window.history .results"),c=d.metric.history();return b.html(""),!1===c?b.html(a.noResults("\u0421\u0431\u043E\u0440 \u0434\u0430\u043D\u043D\u044B\u0445 \u043E\u0442\u043A\u043B\u044E\u0447\u0451\u043D")):void(Object.values(c.get()).reverse().forEach(c=>b.append(a.title(c.id,c.image.preview,c.russian||c.name,c.name,c))),binds.lazyLoad.update())}}},c={_current:"general",_working:[],levels:[],init(){return this.processor()},processor(){switch(this.levels=url.address.split("/"),this.levels[0]){case"player":return this.set("player");case"general":default:return this.set("general");}},set(a){if(-1===Object.keys(this.array).indexOf(a))throw"This page doesn't exist";b.close(),$(".page."+this._current).css("display","none"),"unload"in this.array[this._current]&&this.array[this._current].unload(...Array(...arguments).splice(1)),this._current=a,-1===this._working.indexOf(a)?(this._working.push(a),this.array[a].main(...Array(...arguments).splice(1))):"update"in this.array[a]&&this.array[a].update(...Array(...arguments).splice(1)),$(".page."+a).css("display","inline-block")},array:{general:{state:null,shikimori:shikimori.animes(),main(){$("main>.vcontainer").html(""),this._scrollUpdate()},update(){},load(b=1){this.state="loading",this.shikimori.page(b).then(b=>0===b.length?$(".page.general div.all").append(a.noResults("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0431\u043E\u043B\u044C\u0448\u0435.")):void(b.forEach(b=>{$(".page.general div.all").append(a.title(b.id,b.image.preview,b.russian||b.name,b.name,b))}),App.loaded(),this.state=null,binds.lazyLoad.update(),binds.aWindow.update(),binds.titleHover.update()),()=>{$(".page.general>.vcontainer").html(a.noResults()),console.groupCollapsed("Unable to load titles"),Array(...arguments).forEach(b=>console.error(b)),console.groupEnd()})},_scrollUpdate(){let a=1;this.load(a++),binds.bodyScroll.bind(b=>{let c=b.target.children[0].clientHeight-b.target.scrollTop-b.target.clientHeight;500>c&&"loading"!==this.state&&this.load(a++)},"pages.general._scrollUpdate")}},player:{_current:"kodik",_title:void 0,_data:void 0,main(){App.loaded(),this.update()},load(){},update(){this._title!==c.levels[1].toString()+c.levels[2].toString()&&this.setPlayer(c.levels[1],c.levels[2]),$("header>nav>a.player-show").hide()},setPlayer(b,c){this._title=b.toString()+c.toString(),shikimori.animes().reset().ids([+c]).then(b=>{this._data=b[0],App.title(`KDK - ${this._data.russian||this._data.name}`),$(".page.player .ui-bar").html(a.playerBar(this._data));let c=d.metric.history();c&&c.push({id:this._data.id,name:this._data.name,russian:this._data.russian,image:{preview:this._data.image.preview,original:this._data.image.original}}),binds.aWindow.update()}),$(".page.player .player-"+this._current).hide();let e={kodik:$(".page.player .player-kodik")};switch(b){case"animetop":break;case"shikimori":e.kodik.show(),this.players.kodik.setShikimori(c);break;case"kodik":default:e.kodik.show(),this.players.kodik.setVideo(c);}},players:{kodik:{setShikimori(a){$(".page.player .player-kodik").attr("src",`//kodik.cc/find-player?shikimoriID=${a}`)},setVideo(){}}},unload(){$("header>nav>a.player-show").show().attr("title",this._data.russian||this._data.name||"\u041F\u043B\u0435\u0435\u0440")}}}},d={search:{dom:{results:$(".window.search .results")},search(b){this.dom.results.html(a.loadingResults()),shikimori.animes().status("").order("").search(b).then(b=>{this.dom.results.html(""),0===b.length&&$(".window.search .results").html(a.noResults()),b.forEach(b=>{this.dom.results.append(a.titleEx(b.id,b.image.preview,b.russian||b.name,b.name,b))}),binds.titleHover.update(),binds.lazyLoad.update(),binds.aWindow.update()})}},favorite:{init(){},toggle(){}},clock:{set(){let a=new Date;$(".ui-clock").text((9<a.getHours()?a.getHours():"0"+a.getHours())+":"+(9<a.getMinutes()?a.getMinutes():"0"+a.getMinutes())),window.clock=setInterval(function(){let a=new Date,b=$(".ui-clock"),c=(9<a.getHours()?a.getHours():"0"+a.getHours())+":"+(9<a.getMinutes()?a.getMinutes():"0"+a.getMinutes());b.text()!==c&&b.text(c)},1e3)}},hotkeys(){hotkeys("esc,alt+o,alt+s",function(a,d){switch(d.key){case"esc":null===b.current?c.set("general"):b.close();break;case"alt+o":b.open("config");break;case"alt+s":b.open("search");}})},metric:{state:()=>binds.config.config.collectInformation,init(){},history(){return!!d.metric.state()&&binds.sHistory}},hoverMenu(){binds.titleHover.on("click",a=>{switch(+a){case 0:return url.set("#player/shikimori/"+tile.id,{});case 1:return b.open("title-info",tile);case 2:return d.favorite.toggle(tile);case 4:return navigator.clipboard.writeText(tile.name);case 5:return window.open("https://shikimori.one"+tile.url);}}).on("open",a=>{tile=JSON.parse(a.delegateTarget.dataset.add||"{}")})},schedule:{_cache:{},async animevost(){let a=[[],[],[],[],[],[],[]];return void 0===this._cache.animevost?(await animetop.timetable().then((b,c)=>void 0===c?void b.forEach(b=>{a[b.day].push({name:b.name,time:b.time,from:"AnimeVost"})}):err(c)),this._cache.animevost=a):this._cache.animevost},async anilibria(){let a=[[],[],[],[],[],[],[]];return void 0===this._cache.anilibria?(await binds.anilibria.getSchedule().then((b,c)=>void 0===c?void b.forEach((b,c)=>{b.list.forEach(b=>{a[c].push({name:b.names.ru,time:"\u043D\u0435\u0438\u0437\u0432\u0435\u0441\u0442\u043D\u043E",from:"Anilibria"})})}):err(c)),this._cache.anilibria=a):this._cache.anilibria},_list:["animevost","anilibria"],all(){return new Promise(a=>{let b=[[],[],[],[],[],[],[]];this._list.forEach((c,d)=>{this[c]().then(c=>{if(c.forEach((a,c)=>{b[c]=b[c].concat(a)}),d===this._list.length-1)return a(b)})})})}},styles(){let a=()=>{let a=document.querySelector("header"),b=document.querySelector("#--headerCeilSize").offsetHeight;document.documentElement.style.setProperty("--vh",`${.01*window.innerHeight}px`),a.children[0].style.height=(document.querySelectorAll("header>nav>a[display=true]").length+4)*b>=a.offsetHeight?"fit-content":"100%"};window.addEventListener("resize",a),document.addEventListener("DOMContentLoaded",a),a()},oldConvert:{history(){localStorage.getItem("lsHistory")}},storage:{init(){this.size._build()},size:{_build(){Object.keys(this._old).forEach(a=>this[`old${a}`]=()=>this._Processor(this._old[a])),Object.keys(this._list).forEach(a=>this[a]=()=>this._Processor(this._list[a]))},_Processor(a){let b=localStorage.getItem(a);return null===b?0:new Blob([b]).size},_old:{Favorite:"lsfavorite",Cache:"cache",History:"lshistory"},_list:{favorite:"sFavorite",history:"sHistory"},all(){let a=this.self();return Object.values(this._old).forEach(b=>a+=this._Processor(b)),Object.values(this.list).forEach(b=>a+=this._Processor(b)),a},self(){let a,b=0;return App.info.sources.forEach(c=>{try{a=storage.get(c.name)}catch(a){return console.groupCollapsed("Unable to load file"),console.error(a),console.groupEnd()}b+=new Blob([a]).size}),b}},_data(){let a={system:{size:this.size.self(),description:"\u0424\u0430\u0439\u043B\u044B \u0441\u0430\u0439\u0442\u0430"},oldcache:{size:this.size.oldCache(),description:"\u0421\u0442\u0430\u0440\u044B\u0435 \u0434\u0430\u043D\u043D\u044B\u0435 \u043A\u044D\u0448\u0430"},oldhistory:{size:this.size.oldHistory(),description:"\u0421\u0442\u0430\u0440\u0430\u044F \u0438\u0441\u0442\u043E\u0440\u0438\u044F \u043F\u0440\u043E\u0441\u043C\u043E\u0442\u0440\u043E\u0432"},oldfavorite:{size:this.size.oldFavorite(),description:"\u0421\u0442\u0430\u0440\u044B\u0439 \u0441\u043F\u0438\u0441\u043E\u043A \u043B\u044E\u0431\u0438\u043C\u043E\u0433\u043E"},favorite:{size:this.size.favorite(),description:"\u0421\u043F\u0438\u0441\u043E\u043A \u043B\u044E\u0431\u0438\u043C\u043E\u0433\u043E"},history:{size:this.size.history(),description:"\u0418\u0441\u0442\u043E\u0440\u0438\u044F \u043F\u0440\u043E\u0441\u043C\u043E\u0442\u0440\u043E\u0432"}},b=Object.values(a).reduce((c,a)=>c+a.size,0);return Object.keys(a).forEach(c=>(a[c].part=a[c].size/b,a[c].size=this._convert(a[c].size))),[this._convert(b),a]},_convert(a,b=2){let c=["B","KB","MB"],d=0;for(;1<=Math.floor(a/1024)&&d<c.length;)a/=1024,d++;return Math.floor(a*10**b)/10**b+(c[d]||c[d-1])}},shikimori:{linkTitle(a){return"wikipedia"===a?"Wikipedia":"anime_news_network"===a?"Anime News Network":"myanimelist"===a?"MyAnimeList":"anime_db"===a?"AniDB":"world_art"===a?"World Art":"twitter"===a?"Twitter":"official_site"===a?"\u041E\u0444\u0438\u0446\u0438\u0430\u043B\u044C\u043D\u044B\u0439 \u0441\u0430\u0439\u0442":"kage_project"===a?"Kage Project":"kinopoisk"===a?"\u041A\u0438\u043D\u043E\u043F\u043E\u0438\u0441\u043A":"ruranobe"===a?"\u0420\u0443\u0420\u0430\u043D\u043E\u0431\u044D":"readmanga"===a?"ReadManga":"novelupdates"===a?"NovelUpdates":"mangaupdates"===a?"MangaUpdates":"mangafox"===a?"MangaFox":"mangachan"===a?"\u041C\u0430\u043D\u0433\u0430-\u0442\u044F\u043D":"mangahub"===a?"Mangahub":"smotret_anime"===a?"\u0421\u043C\u043E\u0442\u0440\u0435\u0442\u044C \u0430\u043D\u0438\u043C\u0435":"youtube_channel"===a?"YouTube":"novel_tl"===a?"Novel.tl":"mangalib"===a?"MangaLib":"ranobelib"===a?"RanobeLib":"remanga"===a?"ReManga":"mangadex"===a?"MangaDex":"more_tv"===a?"more.tv":"baike_baidu_wiki"===a?"Baike Baidu Wiki":"namu_wiki"===a?"Namu Wiki":void 0}}};d.storage.init(),d.styles(),d.hoverMenu(),d.hotkeys(),d.clock.set(),App.chrome.sw(),b.bind(),window.workers=d,console.log("KDK Anime v3.0.28.2259")});